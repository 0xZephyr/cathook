/*
 * LagExploit.cpp
 *
 *  Created on: May 7, 2017
 *      Author: nullifiedcat
 */

#include "LagExploit.hpp"

namespace hacks { namespace shared { namespace lagexploit {

CatVar toggle(CV_SWITCH, "removecond_toggle", "0", "Toggle Lag Exploit", "Toggle lag exploit (RemoveCond)");
CatVar key(CV_KEY, "removecond_key", "0", "RemoveCond Key");

float instant_rezoom_timer = 0;
bool instant_rezoom_timer_active = false;
//int instant_rezoom_timer_step = 0;

/*Instant rezoom, except the rezoom buggs for some reason
bool returnInsZoom() {
	if (!instant_rezoom_timer_active) {
		instant_rezoom_timer_active = true;
		instant_rezoom_timer = g_GlobalVars->curtime;
		instant_rezoom_timer_step = 1;
	} else {
		if (instant_rezoom_timer_step >= 2) {
			if (g_GlobalVars->curtime - 0.6F > instant_rezoom_timer && g_pLocalPlayer->bZoomed) {
				instant_rezoom_timer_active = false;
				hacks::shared::aimbot::instant_rezoom_shoot = false;
				return false;
			}
			if (g_GlobalVars->curtime - 0.4F > instant_rezoom_timer && !g_pLocalPlayer->bZoomed) {
				g_pUserCmd->buttons |= IN_ATTACK2;
			}
			return false;
		}
		if (instant_rezoom_timer_step == 1) {
			if (g_GlobalVars->curtime - 0.38F > instant_rezoom_timer && g_pLocalPlayer->bZoomed) return true;
			if (g_GlobalVars->curtime - 0.48F > instant_rezoom_timer ) {
				instant_rezoom_timer = g_GlobalVars->curtime;
				instant_rezoom_timer_step = 2;
				return false; 
			}
			
		}
	}
}*/

//Instant un-zoom 
bool returnInsZoom() {
	if (!instant_rezoom_timer_active) {
		instant_rezoom_timer_active = true;
		instant_rezoom_timer = g_GlobalVars->curtime;
	} else {
		if (!g_pLocalPlayer->bZoomed || g_GlobalVars->curtime - 0.5F > instant_rezoom_timer) {
			instant_rezoom_timer_active = false;
			hacks::shared::aimbot::instant_rezoom_shoot = false;
			return false;
		}
		if (g_GlobalVars->curtime - 0.18F > instant_rezoom_timer) return true;
	}
}

bool ExploitActive() {
	if (toggle) return true;
	if (g_IInputSystem->IsButtonDown((ButtonCode_t)((int)key))) {
		return true;
	}

	//Var from aimbot.cpp to tell when a shot is made
	if (hacks::shared::aimbot::instant_rezoom_shoot) return returnInsZoom();

	return false;
}

void GetUserCmd(CUserCmd* cmd, int sequence_number) {
	if (!ExploitActive()) return;
	if (!cmd) return;
	if (!cmd->command_number) return;
	// at 450 exploit machine :b:reaks
	cmd->command_number += 300;
	*(int*)((unsigned)g_IBaseClientState + offsets::lastoutgoingcommand()) += 300;
	//*(INetChannel**)((unsigned)g_IBaseClientState + offsets::m_NetChannel());
	INetChannel* ch = (INetChannel*)g_IEngine->GetNetChannelInfo();
	int& m_nOutSequenceNr = *(int*)((unsigned)ch + offsets::m_nOutSequenceNr());
	m_nOutSequenceNr += 300;
}

}}}
