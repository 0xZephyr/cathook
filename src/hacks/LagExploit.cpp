/*
 * LagExploit.cpp
 *
 *  Created on: May 7, 2017
 *      Author: nullifiedcat
 */

#include "LagExploit.hpp"

namespace hacks { namespace shared { namespace lagexploit {

CatVar toggle(CV_SWITCH, "removecond_toggle", "0", "Toggle Lag Exploit", "Toggle lag exploit (RemoveCond)");
CatVar key(CV_KEY, "removecond_key", "0", "RemoveCond Key");

int exticks = 0;
void AddExploitTicks(int ticks) {
	exticks = max(ticks, exticks);
}

bool ExploitActive() {
	if (toggle) return true;
	if (exticks > 0) {
		return true;
	}
	if (g_IInputSystem->IsButtonDown((ButtonCode_t)((int)key))) {
		return true;
	}
	return false;
}

void CreateMove() {
	if (exticks > 0) exticks--;
}

void GetUserCmd(CUserCmd* cmd, int sequence_number) {
	if (!ExploitActive()) return;
	if (!cmd) return;
	if (!cmd->command_number) return;
	// at 450 exploit machine :b:reaks
	cmd->command_number += 300;
	*(int*)((unsigned)g_IBaseClientState + offsets::lastoutgoingcommand()) += 300;
	//*(INetChannel**)((unsigned)g_IBaseClientState + offsets::m_NetChannel());
	INetChannel* ch = (INetChannel*)g_IEngine->GetNetChannelInfo();
	int& m_nOutSequenceNr = *(int*)((unsigned)ch + offsets::m_nOutSequenceNr());
	m_nOutSequenceNr += 300;
}

}}}
